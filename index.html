<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>H·ªì Ch√≠ Minh - Ng∆∞·ªùi ƒëi t√¨m h√¨nh c·ªßa N∆∞·ªõc</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts + FontAwesome -->
    <link href="https://fonts.googleapis.com/css2?family=Paytone+One&family=Merriweather:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <!-- Firebase (compat) - optional: enabled only if you paste config below -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        .font-header-footer { font-family: 'Paytone One', sans-serif; }
        .font-normal { font-family: 'Merriweather', serif; }
        .font-quiz { font-family: 'Montserrat', sans-serif; }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            background: linear-gradient(-45deg, #4F46E5, #EC4899, #F59E0B, #60A5FA);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        .quiz-card {
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            animation: fadeIn 0.45s ease-out;
            z-index: 10;
        }

        .text-glow {
            text-shadow: 0 0 6px rgba(0,0,0,0.8);
        }

        .bubbles { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1; overflow:hidden; }
        .bubbles span { position:absolute; background: rgba(255,255,255,0.35); border-radius:50%; animation: moveUp 25s linear infinite; }
        @keyframes moveUp { 0% { transform: translateY(100vh) scale(0); opacity:0; } 50% { opacity:1 } 100% { transform: translateY(-100px) scale(1); opacity:0 } }

        #timer-bar-container { height: 10px; background: #e5e7eb; border-radius: 9999px; margin-bottom: 20px; overflow:hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        #timer-bar { width:100%; height:100%; background:#10b981; transition: width linear; }

        .answer-button { transition: transform 0.12s ease-out, box-shadow 0.12s ease-out, background-color 0.12s ease-out; }
        .answer-button:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.25); }

        .color-1 { background-color: #ef4444; } /* Red */
        .color-2 { background-color: #3b82f6; } /* Blue */
        .color-3 { background-color: #10b981; } /* Green */
        .color-4 { background-color: #f59e0b; } /* Yellow */

        .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; z-index:60; }
        .modal-content { animation: zoomIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); }

        @keyframes fadeIn { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0 } to { transform: scale(1); opacity:1 } }

        /* leaderboard styling */
        .leaderboard-row { display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; }
        .leaderboard-badge { width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; font-weight:700; color:white; }
        .leader-rank-1 { background: linear-gradient(90deg,#FFD54A,#FF8A65); }
        .leader-rank-2 { background: linear-gradient(90deg,#B0BEC5,#90CAF9); }
        .leader-rank-3 { background: linear-gradient(90deg,#C5E1A5,#81C784); }
        .leader-rank { background: #94a3b8; }

        /* reduce confetti on small screens */
        @media (max-width:640px){ .confetti-canvas { opacity:0.95 } }

        /* accessibility focus */
        .answer-button:focus { outline: 3px solid rgba(59,130,246,0.6); outline-offset: 3px; }

        /* colorful instruction boxes - made bolder/darker */
        .rule-box { padding: 1rem; border-radius: 0.75rem; display:flex; gap:0.75rem; align-items:flex-start; border: 1px solid rgba(0,0,0,0.06); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
        .rule-icon { font-size: 1.6rem; }

        /* stronger gradients for instruction panels */
        .rule-blue { background: linear-gradient(90deg,#c7d2fe,#e0e7ff); }
        .rule-indigo { background: linear-gradient(90deg,#c4b5fd,#e9d5ff); }
        .rule-yellow { background: linear-gradient(90deg,#fde68a,#fff7cc); }
        .rule-green { background: linear-gradient(90deg,#bbf7d0,#d1fae5); }

        .rule-title { font-weight: 700; color: #1f2937; }
        .rule-text { color: #111827; font-weight: 500; }

        /* button gradient emphasized */
        .btn-confirm { background: linear-gradient(90deg, #16a34a, #059669); }
        .btn-confirm:hover { background: linear-gradient(90deg, #059669, #047857); }

    </style>
</head>
<body class="p-4 md:p-8">
    <div class="bubbles z-0">
        <span style="left:10%; width:20px; height:20px; animation-duration:10s;"></span>
        <span style="left:20%; width:40px; height:40px; animation-duration:15s;"></span>
        <span style="left:35%; width:15px; height:15px; animation-duration:12s;"></span>
        <span style="left:50%; width:30px; height:30px; animation-duration:18s;"></span>
        <span style="left:65%; width:25px; height:25px; animation-duration:14s;"></span>
        <span style="left:80%; width:50px; height:50px; animation-duration:20s;"></span>
    </div>

    <header class="w-full text-center py-4 text-white font-header-footer text-2xl md:text-3xl tracking-wider mb-6 z-20 text-glow">
        <h1>H·ªí CH√ç MINH - NG∆Ø·ªúI ƒêI T√åM H√åNH C·ª¶A ƒê·∫§T N∆Ø·ªöC</h1>
    </header>

    <div id="main-wrapper" class="flex-grow w-full max-w-4xl">
        <main id="app-container" class="quiz-card rounded-xl p-6 md:p-10 shadow-2xl"></main>
    </div>

    <footer class="w-full text-center py-4 mt-6 text-white font-header-footer text-xs md:text-sm z-20">
        <!-- Footer -->
    </footer>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 modal-overlay hidden">
        <div class="modal-content-wrapper p-4 w-full flex justify-center items-start">
            <div id="modal-content" class="modal-content bg-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full m-4 font-normal text-center">
                <h3 id="modal-title" class="text-2xl font-bold mb-4 font-header-footer text-gray-800"></h3>
                <p id="modal-message" class="text-base mb-4 text-gray-700 font-normal"></p>
                <p id="modal-score" class="text-xl font-bold mb-4 text-green-600 hidden font-header-footer"></p>
                <div id="modal-correct" class="text-left mb-4 hidden p-3 bg-gray-100 rounded-lg text-gray-800 font-normal"></div>
                <div id="modal-explanation" class="text-sm italic text-gray-600 mt-2 p-3 bg-gray-50 rounded-lg hidden text-left font-normal"></div>
                <div id="modal-buttons" class="flex justify-center gap-4 mt-6"></div>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="fixed inset-0 modal-overlay hidden z-70">
        <div class="p-6 w-full max-w-2xl">
            <div class="bg-white rounded-xl p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-header-footer">B·∫£ng x·∫øp h·∫°ng Top 10</h3>
                    <button id="close-leaderboard" class="px-3 py-2 rounded-full bg-red-500 text-white hover:bg-red-600"><i class="fas fa-times"></i></button>
                </div>
                <div id="leaderboard-list" class="space-y-3 max-h-96 overflow-auto"></div>
                <div class="text-right mt-4">
                    <button id="refresh-leaderboard" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700"><i class="fas fa-sync-alt mr-2"></i> L√†m m·ªõi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating controls -->
    <div class="fixed right-4 bottom-6 z-80 flex flex-col gap-3">
        <button id="mute-button" class="p-3 rounded-full bg-white shadow-lg" title="B·∫≠t/T·∫Øt √¢m">
            <i id="mute-icon" class="fas fa-volume-up text-blue-600"></i>
        </button>
        <button id="open-leaderboard" class="p-3 rounded-full bg-white shadow-lg" title="Xem B·∫£ng x·∫øp h·∫°ng">
            <i class="fas fa-trophy text-yellow-500"></i>
        </button>
    </div>

    <script>
    // =========================
    // CONFIG: Firebase placeholder
    // =========================
    // If you want server-shared realtime leaderboard, create a Firebase project and paste your config here.
    // Keep as null to use localStorage fallback.
    const firebaseConfig = null;
    let useFirebase = false;
    if (firebaseConfig) {
        try { firebase.initializeApp(firebaseConfig); useFirebase = true; } catch(e) { console.warn('Firebase init failed', e); useFirebase = false; }
    }

    // =========================
    // STATE & ELEMENTS
    // =========================
    const GAME_STATE = { NAME_INPUT: 'nameInput', INSTRUCTIONS: 'instructions', QUIZ: 'quiz', ROUND_END: 'roundEnd', RESULTS: 'results' };
    const appContainer = document.getElementById('app-container');
    const modalContainer = document.getElementById('modal-container');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalScore = document.getElementById('modal-score');
    const modalExplanation = document.getElementById('modal-explanation');
    const modalCorrect = document.getElementById('modal-correct');
    const modalButtons = document.getElementById('modal-buttons');

    const leaderboardModal = document.getElementById('leaderboard-modal');
    const leaderboardList = document.getElementById('leaderboard-list');
    const openLeaderboardBtn = document.getElementById('open-leaderboard');
    const closeLeaderboardBtn = document.getElementById('close-leaderboard');
    const refreshLeaderboardBtn = document.getElementById('refresh-leaderboard');
    const muteButton = document.getElementById('mute-button');
    const muteIcon = document.getElementById('mute-icon');

    let gameState = GAME_STATE.NAME_INPUT;
    let playerName = '';
    let totalScore = 0;
    let round = 1;
    let roundQuestions = {1: [], 2: []};
    let currentQuestionIndex = 0;
    let isAnswered = false;
    let startTime = 0;
    let timerInterval = null;
    let isMuted = false;

    const MAX_POINTS_PER_QUESTION = 1000;

    // =========================
    // QUESTIONS: merged 40 w/ difficulty
    // =========================
    // NOTE: Question 1 has been updated: correct answer is Ch·ªß nghƒ©a d√¢n t·ªôc (option C).
    const ORIGINAL_QUESTIONS = [
        { id: 1, q: `Nguy·ªÖn √Åi Qu·ªëc ƒë√£ ƒë∆∞a ra nh·∫≠n ƒë·ªãnh nh∆∞ sau v·ªÅ ch·ªß nghƒ©a n√†o?
"‚Ä¶ l√† ƒë·ªông l·ª±c l·ªõn c·ªßa ƒë·∫•t n∆∞·ªõc. Ch√≠nh n√≥ ƒë√£ g√¢y n√™n cu·ªôc n·ªïi d·∫≠y ch·ªëng thu·∫ø nƒÉm 1908, n√≥ d·∫°y cho nh·ªØng ng∆∞·ªùi cu li bi·∫øt ph·∫£n ƒë·ªëi, n√≥ l√†m cho nh·ªØng ng∆∞·ªùi "nh√† qu√™" ph·∫£n ƒë·ªëi ng·∫ßm tr∆∞·ªõc thu·∫ø t·∫°p d·ªãch v√† thu·∫ø mu·ªëi. C≈©ng ‚Ä¶ ƒë√£ lu√¥n lu√¥n th√∫c ƒë·∫©y c√°c nh√† bu√¥n An Nam c·∫°nh tranh v·ªõi ng∆∞·ªùi Ph√°p v√† ng∆∞·ªùi Trung Qu·ªëc; n√≥ ƒë√£ th√∫c gi·ª•c thanh ni√™n b√£i kh√≥a, l√†m cho nh·ªØng nh√† c√°ch m·∫°ng tr·ªën sang Nh·∫≠t B·∫£n v√† l√†m vua Duy T√¢n m∆∞u t√≠nh kh·ªüi nghƒ©a nƒÉm 1917"`, a:["Ch·ªß nghƒ©a t·ª± do","Ch·ªß nghƒ©a c·ªông s·∫£n","Ch·ªß nghƒ©a d√¢n t·ªôc","Ch·ªß nghƒ©a y√™u n∆∞·ªõc"], correctIndex: 2, info:"ƒê√°p √°n: Ch·ªß nghƒ©a d√¢n t·ªôc. Trong ƒëo·∫°n tr√≠ch n√†y, Nguy·ªÖn √Åi Qu·ªëc nh·∫•n m·∫°nh vai tr√≤ c·ªßa tinh th·∫ßn d√¢n t·ªôc (√Ω th·ª©c y√™u n∆∞·ªõc/d√¢n t·ªôc) nh∆∞ m·ªôt ƒë·ªông l·ª±c l·ªãch s·ª≠.", difficulty: "hard" },
        { id: 2, q: "Theo B√°c, ∆∞u ƒëi·ªÉm c·ªßa h·ªçc thuy·∫øt Kh·ªïng T·ª≠ l√† g√¨?", a:["L√≤ng nh√¢n √°i","Tu d∆∞·ª°ng ƒë·∫°o ƒë·ª©c c√° nh√¢n","T·ª± do c√° nh√¢n","Ph√©p bi·ªán ch·ª©ng"], correctIndex:1, info:"B√°c n√™u r√µ: ‚ÄúH·ªçc thuy·∫øt Kh·ªïng T·ª≠ c√≥ ∆∞u ƒëi·ªÉm l√† s·ª± tu d∆∞·ª°ng ƒë·∫°o ƒë·ª©c c√° nh√¢n.‚Äù", difficulty: "hard" },
        { id: 3, q: "ƒêi·ªÉm Ng∆∞·ªùi ƒë√°nh gi√° cao nh·∫•t ·ªü ch·ªß nghƒ©a M√°c l√†:", a:["Ch√≠nh s√°ch d√¢n sinh","Ph∆∞∆°ng ph√°p l√†m vi·ªác bi·ªán ch·ª©ng","Tinh th·∫ßn b√°c √°i","L√≤ng y√™u n∆∞·ªõc"], correctIndex:1, info:"Theo l·ªùi B√°c: ‚ÄúCh·ªß nghƒ©a M√°c c√≥ ∆∞u ƒëi·ªÉm l√† ph∆∞∆°ng ph√°p l√†m vi·ªác bi·ªán ch·ª©ng.‚Äù", difficulty: "hard" },
        { id: 4, q: "H·ªì Ch√≠ Minh kh·∫≥ng ƒë·ªãnh m·ª•c ti√™u l·ªõn nh·∫•t c·ªßa m·ªçi h·ªçc thuy·∫øt ti·∫øn b·ªô l√†:", a:["X√¢y d·ª±ng th·ªÉ ch·∫ø m·ªõi","Gi·∫£i ph√≥ng con ng∆∞·ªùi, m∆∞u h·∫°nh ph√∫c cho m·ªçi ng∆∞·ªùi","N√¢ng cao kinh t·∫ø","Ph√°t tri·ªÉn khoa h·ªçc"], correctIndex:1, info:"B√°c nh·∫≠n x√©t r·∫±ng c√°c h·ªçc thuy·∫øt l·ªõn ƒë·ªÅu 'ƒë·ªÅu nh·∫±m m∆∞u c·∫ßu h·∫°nh ph√∫c cho lo√†i ng∆∞·ªùi'.", difficulty: "hard" },
        { id: 5, q: "Con ƒë∆∞·ªùng c·ª©u n∆∞·ªõc m√† H·ªì Ch√≠ Minh l·ª±a ch·ªçn l√† g√¨?", a:["ƒêi sang ph∆∞∆°ng ƒê√¥ng","ƒêi sang ph∆∞∆°ng T√¢y","·ªû l·∫°i trong n∆∞·ªõc","T√¨m s·ª± gi√∫p ƒë·ª° t·ª´ Trung Qu·ªëc"], correctIndex:1, info:"Ng∆∞·ªùi quy·∫øt t√¢m ƒëi sang ph∆∞∆°ng T√¢y (Ph√°p) ƒë·ªÉ t√¨m hi·ªÉu n·ªÅn vƒÉn minh, ch√≠nh tr·ªã v√† c√°ch m·∫°ng c·ªßa c√°c n∆∞·ªõc t∆∞ b·∫£n.", difficulty: "hard" },
        { id: 6, q: "T·ª´ nƒÉm 1912-1917, H·ªì Ch√≠ Minh l√†m vi·ªác t·∫°i ƒë√¢u?", a:["Anh","M·ªπ","Ph√°p","ƒê·ª©c"], correctIndex:0, info:"Trong giai ƒëo·∫°n n√†y, Ng∆∞·ªùi s·ªëng v√† l√†m vi·ªác ·ªü Anh (London) v√† sau ƒë√≥ l√† M·ªπ, tr∆∞·ªõc khi tr·ªü l·∫°i Ph√°p.", difficulty: "easy" },
        { id: 7, q: "H·ªì Ch√≠ Minh kh√¥ng t√°n th√†nh con ƒë∆∞·ªùng c·ª©u n∆∞·ªõc c·ªßa Phan Ch√¢u Trinh v√† Phan B·ªôi Ch√¢u v√¨:", a:["Hai √¥ng kh√¥ng quan t√¢m ƒë·∫øn truy·ªÅn b√° ch·ªØ qu·ªëc ng·ªØ.","Hai √¥ng ƒë·ªÅu ch·ªß tr∆∞∆°ng ƒë·∫•u tranh b·∫°o l·ª±c.","Con ƒë∆∞·ªùng c·ªßa h·ªç ph·ª• thu·ªôc v√†o th·∫ø l·ª±c b√™n ngo√†i.","Hai √¥ng kh√¥ng quan t√¢m ƒë·∫øn t·ªï ch·ª©c c√°ch m·∫°ng ·ªü n∆∞·ªõc ngo√†i."], correctIndex:2, info:"Tuy kh√¢m ph·ª•c Phan Ch√¢u Trinh, Phan B·ªôi Ch√¢u nh∆∞ng Ng∆∞·ªùi kh√¥ng t√°n th√†nh con ƒë∆∞·ªùng c·ªßa h·ªç: Phan Ch√¢u Trinh 'xin gi·∫∑c r·ªß l√≤ng th∆∞∆°ng', Phan B·ªôi Ch√¢u 'ƒëu·ªïi h·ªï c·ª≠a tr∆∞·ªõc, r∆∞·ªõc beo c·ª≠a sau'.", difficulty: "hard" },
        { id: 8, q: "ƒê·∫∑c ƒëi·ªÉm n√†o KH√îNG thu·ªôc phong c√°ch ngh·ªá thu·∫≠t c·ªßa th∆° H·ªì Ch√≠ Minh?", a:["Ng√¥n ng·ªØ c√¥ ƒë·ªçng, gi√†u t√≠nh t∆∞·ª£ng tr∆∞ng","Phong v·ªã c·ªï ƒëi·ªÉn k·∫øt h·ª£p h∆°i th·ªü hi·ªán ƒë·∫°i","H√¨nh ·∫£nh gi·∫£n d·ªã, g·∫ßn g≈©i, gi√†u nh√¢n vƒÉn","S·ª≠ d·ª•ng ho√†n to√†n phong c√°ch l√£ng m·∫°n T√¢y ph∆∞∆°ng"], correctIndex:3, info:"Th∆° H·ªì Ch√≠ Minh l√† s·ª± k·∫øt h·ª£p nhu·∫ßn nhuy·ªÖn gi·ªØa c·ªï ƒëi·ªÉn v√† hi·ªán ƒë·∫°i, kh√¥ng 'ho√†n to√†n' l√£ng m·∫°n T√¢y ph∆∞∆°ng.", difficulty: "easy" },
        { id: 9, q: "ƒêi·ªÉm t∆∞∆°ng ƒë·ªìng v·ªÅ vai tr√≤ c·ªßa Ng∆∞·ªùi trong C√°ch m·∫°ng th√°ng T√°m nƒÉm 1945, kh√°ng chi·∫øn ch·ªëng Ph√°p (1945-1954) v√† kh√°ng chi·∫øn ch·ªëng M·ªπ (1954-1975) l√†", a:["l√£nh ƒë·∫°o c√°ch m·∫°ng Vi·ªát Nam th·ª±c hi·ªán kh√°ng chi·∫øn v√† ki·∫øn qu·ªëc.","l√£nh ƒë·∫°o c√°ch m·∫°ng Vi·ªát Nam th·ª±c hi·ªán nhi·ªám v·ª• x√¢y d·ª±ng ch·∫ø ƒë·ªô m·ªõi.","l√£nh ƒë·∫°o cu·ªôc c√°ch m·∫°ng gi·∫£i ph√≥ng v√† b·∫£o v·ªá t·ªï qu·ªëc.","l√£nh ƒë·∫°o c√°ch m·∫°ng Vi·ªát Nam th·ª±c hi·ªán nhi·ªám v·ª• th·ªëng nh·∫•t ƒë·∫•t n∆∞·ªõc."], correctIndex:0, info:"Vai tr√≤ c·ªßa Ng∆∞·ªùi xuy√™n su·ªët l√† l√£nh ƒë·∫°o to√†n d√¢n th·ª±c hi·ªán ƒë·ªìng th·ªùi hai nhi·ªám v·ª• chi·∫øn l∆∞·ª£c.", difficulty: "hard" },
        { id: 10, q: "\"Ng∆∞·ªùi ƒëi t√¨m h√¨nh c·ªßa n∆∞·ªõc\" l√† t√™n m·ªôt b√†i th∆° c·ªßa t√°c gi·∫£ n√†o?", a:["T·ªë H·ªØu","Xu√¢n Di·ªáu","Ch·∫ø Lan Vi√™n","Nguy·ªÖn ƒê√¨nh Thi"], correctIndex:2, info:"ƒê√¢y l√† b√†i th∆° n·ªïi ti·∫øng ƒë∆∞·ª£c Ch·∫ø Lan Vi√™n s√°ng t√°c.", difficulty: "easy" },
        { id: 11, q: "H·ªì Ch√≠ Minh l·∫•y b√≠ danh 'Nguy·ªÖn √Åi Qu·ªëc' khi n√†o?", a:["1911","1917","1919","1930"], correctIndex:2, info:"Nguy·ªÖn √Åi Qu·ªëc b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng b√≠ danh n√†y trong nh·ªØng nƒÉm ho·∫°t ƒë·ªông s·ªõm ·ªü ch√¢u √Çu (g·∫ßn nƒÉm 1919).", difficulty: "easy" },
        { id: 12, q: "ƒêi·ªÅu n√†o sau ƒë√¢y l√† ph·∫©m ch·∫•t n·ªïi b·∫≠t c·ªßa H·ªì Ch√≠ Minh trong l√£nh ƒë·∫°o?", a:["T√≠nh nh√¢n vƒÉn v√† khi√™m t·ªën","Ham danh v·ªçng","Thi·∫øu ki√™n nh·∫´n","Kh√¥ng quan t√¢m ƒë·∫øn nh√¢n d√¢n"], correctIndex:0, info:"H·ªì Ch√≠ Minh n·ªïi b·∫≠t v·ªõi ph·∫©m ch·∫•t nh√¢n vƒÉn, gi·∫£n d·ªã v√† khi√™m t·ªën.", difficulty: "easy" },
        { id: 13, q: "Ai l√† ng∆∞·ªùi h∆∞·ªõng cho Nguy·ªÖn T·∫•t Th√†nh ƒë·∫øn vi·ªác t√¨m con ƒë∆∞·ªùng c·ª©u n∆∞·ªõc th√¥ng qua h·ªçc ti·∫øng Ph√°p v√† t√¨m hi·ªÉu Ph√°p?", a:["Phan B·ªôi Ch√¢u","Phan Ch√¢u Trinh","Nguy·ªÖn Sinh S·∫Øc","Ho√†ng Hoa Th√°m"], correctIndex:2, info:"C·ª• Ph√≥ b·∫£ng Nguy·ªÖn Sinh S·∫Øc hun ƒë√∫c quy·∫øt t√¢m v√† g·ª£i m·ªü h∆∞·ªõng ƒëi t√¨m ƒë∆∞·ªùng c·ª©u n∆∞·ªõc.", difficulty: "hard" },
        { id: 14, q: "Nguy·ªÖn T·∫•t Th√†nh v√≠ con ƒë∆∞·ªùng c·ª©u n∆∞·ªõc c·ªßa Phan B·ªôi Ch√¢u nh∆∞ 'ƒë∆∞a h·ªï c·ª≠a tr∆∞·ªõc, r∆∞·ªõc beo c·ª≠a sau' v√¨ Phan B·ªôi Ch√¢u d·ª±a v√†o c∆∞·ªùng qu·ªëc n√†o?", a:["Nh·∫≠t B·∫£n","Trung Hoa","ƒê·ª©c","M·ªπ"], correctIndex:0, info:"Phan B·ªôi Ch√¢u hy v·ªçng Nh·∫≠t gi√∫p ƒëu·ªïi Ph√°p n√™n Nguy·ªÖn T·∫•t Th√†nh c·∫£nh gi√°c.", difficulty: "easy" },
        { id: 15, q: "Nguy·ªÖn √Åi Qu·ªëc l√† m·ªôt trong nh·ªØng ng∆∞·ªùi b·ªè phi·∫øu ·ªßng h·ªô gia nh·∫≠p Qu·ªëc t·∫ø th·ª© III c·ªßa ƒê·∫£ng X√£ h·ªôi n∆∞·ªõc n√†o v√†o nƒÉm 1920?", a:["Anh","Ph√°p","ƒê·ª©c","T√¢y Ban Nha"], correctIndex:1, info:"Ng√†y 29-12-1920, t·∫°i ƒê·∫°i h·ªôi Tours c·ªßa ƒê·∫£ng X√£ h·ªôi Ph√°p, Nguy·ªÖn √Åi Qu·ªëc ·ªßng h·ªô gia nh·∫≠p Qu·ªëc t·∫ø th·ª© III.", difficulty: "easy" },
        { id: 16, q: "Nguy·ªÖn √Åi Qu·ªëc ƒë√£ vi·∫øt v·ªü k·ªãch 'Con r·ªìng tre' ƒë·ªÉ v·∫°ch tr·∫ßn vua nh√† Nguy·ªÖn n√†o?", a:["T·ª± ƒê·ª©c","Kh·∫£i ƒê·ªãnh","B·∫£o ƒê·∫°i","ƒê·ªìng Kh√°nh"], correctIndex:1, info:"NƒÉm 1922, Nguy·ªÖn √Åi Qu·ªëc vi·∫øt v·ªü k·ªãch 'Con r·ªìng tre' t·ªë c√°o b·ªô m·∫∑t b√°n n∆∞·ªõc.", difficulty: "hard" },
        { id: 17, q: "Khi tr·ªü v·ªÅ T·ªï qu·ªëc sau 30 nƒÉm b√¥n ba (1911-1941), B√°c ƒë√£ ƒë·∫∑t ch√¢n l√™n ƒë·ªãa ph∆∞∆°ng n√†o ƒë·∫ßu ti√™n?", a:["Cao B·∫±ng","H√† Giang","L·∫°ng S∆°n","L√†o Cai"], correctIndex:0, info:"M·ªôt trong nh·ªØng n∆°i B√°c ƒë·∫øn v√† ho·∫°t ƒë·ªông s·ªõm l√† Cao B·∫±ng.", difficulty: "easy" },
        { id: 18, q: "Nguy·ªÖn T·∫•t Th√†nh ƒë√£ gi·∫£ng d·∫°y nh·ªØng m√¥n n√†o t·∫°i tr∆∞·ªùng D·ª•c Thanh?", a:["Ch·ªØ H√°n, ch·ªØ N√¥m v√† ti·∫øng Ph√°p","Ch·ªØ H√°n, ti·∫øng Ph√°p v√† ti·∫øng Anh","Ch·ªØ Qu·ªëc ng·ªØ, ch·ªØ H√°n v√† ti·∫øng Ph√°p","Ch·ªØ Qu·ªëc ng·ªØ, ti·∫øng Ph√°p v√† ti·∫øng Anh"], correctIndex:2, info:"Ng∆∞·ªùi ph·ª• tr√°ch Qu·ªëc vƒÉn (ch·ªØ Qu·ªëc ng·ªØ), H√°n vƒÉn v√† khi c·∫ßn ƒë√£ d·∫°y ti·∫øng Ph√°p.", difficulty: "easy" },
        { id: 19, q: "Phong tr√†o 'H·ªçc t·∫≠p v√† l√†m theo t∆∞ t∆∞·ªüng, ƒë·∫°o ƒë·ª©c, phong c√°ch H·ªì Ch√≠ Minh' nh·∫±m m·ª•c ƒë√≠ch g√¨?", a:["H·ªçc l√Ω thuy·∫øt ch√≠nh tr·ªã thu·∫ßn t√∫y","√Åp d·ª•ng k·ª∑ lu·∫≠t nghi√™m ng·∫∑t","Bi·∫øn t·∫•m g∆∞∆°ng c·ªßa B√°c th√†nh h√†nh ƒë·ªông thi·∫øt th·ª±c trong ƒë·ªùi s·ªëng","T·∫°o phong tr√†o thi ƒëua h√¨nh th·ª©c"], correctIndex:2, info:"Phong tr√†o nh·∫•n m·∫°nh vi·ªác h·ªçc v√† th·ª±c h√†nh nh·ªØng ƒëi·ªÅu gi·∫£n d·ªã, thi·∫øt th·ª±c m√† B√°c d·∫°y.", difficulty: "easy" },
        { id: 20, q: "Qu√™ h∆∞∆°ng c·ªßa H·ªì Ch√≠ Minh n·∫±m ·ªü t·ªânh n√†o?", a:["H√† N·ªôi","Ngh·ªá An","Th·ª´a Thi√™n - Hu·∫ø","Qu·∫£ng Nam"], correctIndex:1, info:"H·ªì Ch√≠ Minh sinh ·ªü l√†ng Kim Li√™n, x√£ Nam ƒê√†n, t·ªânh Ngh·ªá An.", difficulty: "easy" }
    ];

    const NEW_QUESTIONS = [
        { id: 21, q: "T√™n khai sinh c·ªßa Ch·ªß t·ªãch H·ªì Ch√≠ Minh l√† g√¨?", a:["Nguy·ªÖn T·∫•t Th√†nh","Nguy·ªÖn Sinh Cung","Nguy·ªÖn √Åi Qu·ªëc","Nguy·ªÖn Sinh S·∫Øc"], correctIndex:1, info:"T√™n khai sinh l√† Nguy·ªÖn Sinh Cung.", difficulty: "easy" },
        { id: 22, q: "H·ªì Ch√≠ Minh ra ƒëi t√¨m ƒë∆∞·ªùng c·ª©u n∆∞·ªõc v√†o ng√†y n√†o?", a:["5/6/1911","3/2/1911","2/9/1911","19/5/1911"], correctIndex:0, info:"Ng√†y 5‚Äì6‚Äì1911, Ng∆∞·ªùi l√™n t√†u ƒê√¥ ƒë·ªëc Latouche Tr√©ville t·∫°i B·∫øn c·∫£ng Nh√† R·ªìng.", difficulty: "easy" },
        { id: 23, q: "H√†nh tr√¨nh t√¨m ƒë∆∞·ªùng c·ª©u n∆∞·ªõc c·ªßa Nguy·ªÖn √Åi Qu·ªëc v√† Phan B·ªôi Ch√¢u c√≥ ƒëi·ªÉm t∆∞∆°ng ƒë·ªìng v·ªÅ:", a:["H∆∞·ªõng ƒëi t√¨m ƒë∆∞·ªùng c·ª©u n∆∞·ªõc.","L·ª±a ch·ªçn khuynh h∆∞·ªõng c·ª©u n∆∞·ªõc.","Ch·ªß tr∆∞∆°ng d·ª±a v√†o Nh·∫≠t B·∫£n.","M·ª•c ƒë√≠ch cao nh·∫•t v√† cu·ªëi c√πng."], correctIndex:3, info:"M·ª•c ƒë√≠ch cao nh·∫•t v√† cu·ªëi c√πng c·ªßa hai ng∆∞·ªùi l√† ƒëem l·∫°i ƒë·ªôc l·∫≠p, t·ª± do cho ƒë·∫•t n∆∞·ªõc.", difficulty: "hard" },
        { id: 24, q: "Nguy·ªÖn √Åi Qu·ªëc ti·∫øp c·∫≠n ch·ªß nghƒ©a C·ªông s·∫£n qua t√°c ph·∫©m n√†o?", a:["T∆∞ b·∫£n lu·∫≠n","Nh√† n∆∞·ªõc v√† C√°ch m·∫°ng","S∆° th·∫£o l·∫ßn th·ª© nh·∫•t nh·ªØng Lu·∫≠n c∆∞∆°ng v·ªÅ v·∫•n ƒë·ªÅ d√¢n t·ªôc v√† thu·ªôc ƒë·ªãa","Ch·ªëng ƒêuy-rinh"], correctIndex:2, info:"NƒÉm 1920, Nguy·ªÖn √Åi Qu·ªëc ƒë·ªçc 'S∆° th·∫£o...' c·ªßa L√™nin d·∫´n ƒë·∫øn ch·ªß nghƒ©a c·ªông s·∫£n.", difficulty: "easy" },
        { id: 25, q: "Nguy√™n nh√¢n quy·∫øt ƒë·ªãnh th√†nh c√¥ng c·ªßa h·ªôi ngh·ªã th√†nh l·∫≠p ƒê·∫£ng C·ªông s·∫£n Vi·ªát Nam l√†?", a:["Do t√†i nƒÉng, uy t√≠n c·ªßa Nguy·ªÖn √Åi Qu·ªëc.","S·ª± ch·ªâ ƒë·∫°o k·ªãp th·ªùi c·ªßa Qu·ªëc t·∫ø th·ª© hai.","S·ª± gi√∫p ƒë·ª° c·ªßa Li√™n X√¥ v√† Qu·ªëc t·∫ø th·ª© ba.","Nguy·ªán v·ªçng c·ªßa c√°c t·ªï ch·ª©c c·ªông s·∫£n."], correctIndex:2, info:"Y·∫øu t·ªë qu·ªëc t·∫ø v√† h·ªó tr·ª£ c·ªßa Qu·ªëc t·∫ø C·ªông s·∫£n g√≥p ph·∫ßn quan tr·ªçng.", difficulty: "hard" },
        { id: 26, q: "T√™n 'Vi·ªát Minh' ƒë∆∞·ª£c l·∫•y v√†o th·ªùi gian n√†o?", a:["5/1940","5/1941","6/1941","6/1940"], correctIndex:1, info:"Vi·ªát Minh ƒë∆∞·ª£c th√†nh l·∫≠p v√† l·∫•y t√™n v√†o th√°ng 5/1941.", difficulty: "easy" },
        { id: 27, q: "T·ª´ nƒÉm 1945 ƒë·∫øn nƒÉm 1969, H·ªì Ch√≠ Minh ƒë·∫£m nh·∫≠n c∆∞∆°ng v·ªã n√†o sau ƒë√¢y?", a:["Ch·ªß t·ªãch n∆∞·ªõc C·ªông h√≤a x√£ h·ªôi ch·ªß nghƒ©a Vi·ªát Nam.","T·ªïng B√≠ th∆∞ n∆∞·ªõc Vi·ªát Nam D√¢n ch·ªß C·ªông h√≤a.","T·ªïng B√≠ th∆∞ n∆∞·ªõc C·ªông h√≤a x√£ h·ªôi ch·ªß nghƒ©a Vi·ªát Nam.","Ch·ªß t·ªãch n∆∞·ªõc Vi·ªát Nam D√¢n ch·ªß C·ªông h√≤a."], correctIndex:3, info:"√îng l√† Ch·ªß t·ªãch n∆∞·ªõc Vi·ªát Nam D√¢n ch·ªß C·ªông h√≤a.", difficulty: "easy" },
        { id: 28, q: "‚ÄúNh·∫≠t k√Ω trong t√π‚Äù ƒë∆∞·ª£c s√°ng t√°c trong ho√†n c·∫£nh n√†o?", a:["Khi ·ªü Li√™n X√¥","Khi ·ªü P√°c B√≥","Khi ·ªü Trung Qu·ªëc","Khi ·ªü Ph√°p"], correctIndex:2, info:"T·∫≠p th∆° ƒë∆∞·ª£c vi·∫øt b·∫±ng ch·ªØ H√°n trong th·ªùi gian Ng∆∞·ªùi b·ªã t√π ·ªü Trung Qu·ªëc.", difficulty: "hard" },
        { id: 29, q: "Phong c√°ch th∆° H·ªì Ch√≠ Minh mang ƒë·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t n√†o?", a:["D·ª©t kho√°t","C√¥ ƒë·ªçng, s√∫c t√≠ch","H√≤a quy·ªán c·ªï ƒëi·ªÉn v√† hi·ªán ƒë·∫°i","L√£ng m·∫°n"], correctIndex:2, info:"Th∆° c·ªßa B√°c mang ƒë·∫≠m phong v·ªã c·ªï ƒëi·ªÉn v√† tinh th·∫ßn hi·ªán ƒë·∫°i.", difficulty: "hard" },
        { id: 30, q: "H√¨nh t∆∞·ª£ng xu·∫•t hi·ªán nhi·ªÅu nh·∫•t trong th∆° H·ªì Ch√≠ Minh l√† g√¨?", a:["TrƒÉng","Hoa","N√∫i","S√¥ng"], correctIndex:0, info:"TrƒÉng l√† h√¨nh t∆∞·ª£ng xu·∫•t hi·ªán nhi·ªÅu, v√≠ d·ª• 'Ng·∫Øm trƒÉng'.", difficulty: "easy" },

        { id: 31, q: "H·ªì Ch√≠ Minh xu·∫•t th√¢n trong m·ªôt gia ƒë√¨nh:", a:["Nh√† nho y√™u n∆∞·ªõc.","Ti·ªÉu t∆∞ s·∫£n.","N√¥ng d√¢n ngh√®o.","T∆∞ s·∫£n d√¢n t·ªôc."], correctIndex:0, info:"Cha c·ªßa Ng∆∞·ªùi, Nguy·ªÖn Sinh S·∫Øc, l√† nh√† nho y√™u n∆∞·ªõc.", difficulty: "easy" },
        { id: 32, q: "S·ª± ki·ªán n√†o ƒë√°nh d·∫•u Ng∆∞·ªùi t√¨m ra con ƒë∆∞·ªùng gi·∫£i ph√≥ng d√¢n t·ªôc ƒë√∫ng ƒë·∫Øn?", a:["G·ª≠i 'Y√™u s√°ch c·ªßa nh√¢n d√¢n An Nam' t·ªõi Versailles","Tham gia ƒê·∫£ng x√£ h·ªôi Ph√°p","ƒê·ªçc 'S∆° th·∫£o ...' c·ªßa L√™nin","Gia nh·∫≠p ƒê·∫£ng C·ªông S·∫£n Ph√°p"], correctIndex:2, info:"NƒÉm 1920, ƒë·ªçc 'S∆° th·∫£o...' c·ªßa L√™nin ƒë√£ gi·∫£i ƒë√°p con ƒë∆∞·ªùng gi√†nh ƒë·ªôc l·∫≠p.", difficulty: "easy" },
        { id: 33, q: "Trong giai ƒëo·∫°n 1921‚Äì1930, h√¨nh th·ª©c ho·∫°t ƒë·ªông c√°ch m·∫°ng c·ªßa Nguy·ªÖn √Åi Qu·ªëc l√† g√¨?", a:["ƒê·∫•u tranh v≈© trang","Bi·ªÉu t√¨nh","Vi·∫øt b√°o, xu·∫•t b·∫£n s√°ch","Kh·ªüi nghƒ©a"], correctIndex:2, info:"Giai ƒëo·∫°n n√†y Ng∆∞·ªùi truy·ªÅn b√° ch·ªß nghƒ©a M√°c-L√™nin qua vi·∫øt b√°o, xu·∫•t b·∫£n.", difficulty: "hard" },
        { id: 34, q: "S·ª± ki·ªán n√†o ƒë√°nh d·∫•u Nguy·ªÖn √Åi Qu·ªëc b∆∞·ªõc v√†o th·ªùi k·ª≥ tr·ª±c ti·∫øp l√£nh ƒë·∫°o c√°ch m·∫°ng?", a:["Th√†nh l·∫≠p Vi·ªát Minh (5/1941)","Tr·ªü v·ªÅ T·ªï qu·ªëc (1/1941)","H·ªôi ngh·ªã l·∫ßn VIII BCHTW (5/1941)","Th√†nh l·∫≠p ƒê·ªôi VN tuy√™n truy·ªÅn gi·∫£i ph√≥ng qu√¢n (12/1944)"], correctIndex:0, info:"Vi·ªác th√†nh l·∫≠p Vi·ªát Minh kh·∫≥ng ƒë·ªãnh Ng∆∞·ªùi b∆∞·ªõc v√†o vai tr√≤ l√£nh ƒë·∫°o tr·ª±c ti·∫øp.", difficulty: "hard" },
        { id: 35, q: "Nguy·ªÖn √Åi Qu·ªëc l·∫•y t√™n H·ªì Ch√≠ Minh l·∫ßn ƒë·∫ßu ti√™n khi:", a:["Sang Xi√™m ho·∫°t ƒë·ªông (1928)","B·ªã ch√≠nh quy·ªÅn Anh b·∫Øt ·ªü H·ªìng K√¥ng (1931)","T·ª´ Li√™n X√¥ ƒë·∫øn Trung Qu·ªëc ƒë·ªÉ chu·∫©n b·ªã v·ªÅ n∆∞·ªõc (1938)","Sang Trung Qu·ªëc ƒë·ªÉ v·∫≠n ƒë·ªông ngo·∫°i giao (1942)"], correctIndex:2, info:"T√™n H·ªì Ch√≠ Minh ƒë∆∞·ª£c s·ª≠ d·ª•ng trong th·ªùi k·ª≥ tr∆∞·ªõc khi chu·∫©n b·ªã v·ªÅ n∆∞·ªõc.", difficulty: "hard" },
        { id: 36, q: "B·∫£n Tuy√™n ng√¥n ƒê·ªôc l·∫≠p c√≥ √Ω nghƒ©a n·ªØa l√†:", a:["Kh·∫≥ng ƒë·ªãnh ch·ªß nghƒ©a t∆∞ b·∫£n h·∫øt vai tr√≤","B√°o hi·ªáu ra ƒë·ªùi nh√† n∆∞·ªõc c√¥ng n√¥ng ƒë·∫ßu ti√™n ·ªü ƒê√¥ng Nam √Å","Tuy√™n b·ªë chi·∫øn tranh v·ªõi Ph√°p","Kh·∫≥ng ƒë·ªãnh k·∫øt th√∫c qu√¢n ch·ªß tr√™n to√†n th·∫ø gi·ªõi"], correctIndex:1, info:"Tuy√™n ng√¥n khai sinh nh√† n∆∞·ªõc c√¥ng-n√¥ng ƒë·∫ßu ti√™n ·ªü khu v·ª±c.", difficulty: "hard" },
        { id: 37, q: "ƒêi·ªÅu g√¨ khi·∫øn Ng∆∞·ªùi kh√¥ng t√°n th√†nh con ƒë∆∞·ªùng c·ªßa Phan B·ªôi Ch√¢u v√† Phan Ch√¢u Trinh?", a:["Kh√¥ng ch√∫ tr·ªçng truy·ªÅn b√° ch·ªØ qu·ªëc ng·ªØ","Ch·ªß tr∆∞∆°ng ƒë·∫•u tranh b·∫°o l·ª±c","Ph·ª• thu·ªôc th·∫ø l·ª±c b√™n ngo√†i","Kh√¥ng quan t√¢m t·ªï ch·ª©c c√°ch m·∫°ng ·ªü n∆∞·ªõc ngo√†i"], correctIndex:2, info:"Ng∆∞·ªùi cho r·∫±ng con ƒë∆∞·ªùng c·ªßa h·ªç c√≥ th·ªÉ d·∫´n ƒë·∫øn l·ªá thu·ªôc v√†o th·∫ø l·ª±c kh√°c.", difficulty: "hard" },
        { id: 38, q: "ƒê·∫∑c ƒëi·ªÉm n√†o KH√îNG thu·ªôc phong c√°ch ngh·ªá thu·∫≠t c·ªßa th∆° H·ªì Ch√≠ Minh?", a:["Ng√¥n ng·ªØ c√¥ ƒë·ªçng, gi√†u t√≠nh t∆∞·ª£ng tr∆∞ng","Phong v·ªã c·ªï ƒëi·ªÉn k·∫øt h·ª£p h∆°i th·ªü hi·ªán ƒë·∫°i","H√¨nh ·∫£nh gi·∫£n d·ªã, g·∫ßn g≈©i, gi√†u nh√¢n vƒÉn","S·ª≠ d·ª•ng ho√†n to√†n phong c√°ch l√£ng m·∫°n T√¢y ph∆∞∆°ng"], correctIndex:3, info:"Th∆° B√°c kh√¥ng s·ª≠ d·ª•ng ho√†n to√†n phong c√°ch l√£ng m·∫°n T√¢y ph∆∞∆°ng.", difficulty: "easy" },
        { id: 39, q: "ƒêi·ªÉm t∆∞∆°ng ƒë·ªìng v·ªÅ vai tr√≤ c·ªßa Ng∆∞·ªùi trong c√°c cu·ªôc c√°ch m·∫°ng l√†:", a:["L√£nh ƒë·∫°o c√°ch m·∫°ng th·ª±c hi·ªán kh√°ng chi·∫øn v√† ki·∫øn qu·ªëc.","L√£nh ƒë·∫°o x√¢y d·ª±ng ch·∫ø ƒë·ªô m·ªõi.","L√£nh ƒë·∫°o cu·ªôc c√°ch m·∫°ng gi·∫£i ph√≥ng v√† b·∫£o v·ªá T·ªï qu·ªëc.","l√£nh ƒë·∫°o v·ª´a ƒë·∫•u tranh v·ª´a x√¢y d·ª±ng CNXH."], correctIndex:0, info:"Vai tr√≤ xuy√™n su·ªët: l√£nh ƒë·∫°o nh√¢n d√¢n kh√°ng chi·∫øn v√† ki·∫øn qu·ªëc.", difficulty: "hard" },
        { id: 40, q: "H·ªì Ch√≠ Minh KH√îNG ƒë·ªÉ l·∫°i di s·∫£n v·ªÅ:", a:["Ngh·ªá thu·∫≠t qu√¢n s·ª±","L·ªãch s·ª≠","T∆∞ t∆∞·ªüng","VƒÉn h·ªçc"], correctIndex:0, info:"So v·ªõi c√°c lƒ©nh v·ª±c kh√°c, 'ngh·ªá thu·∫≠t qu√¢n s·ª±' kh√¥ng ph·∫£i l√† di s·∫£n ch·ªß y·∫øu ƒë∆∞·ª£c g√°n tr·ª±c ti·∫øp cho Ng∆∞·ªùi.", difficulty: "hard" }
    ];

    const ALL_QUESTIONS = [...ORIGINAL_QUESTIONS, ...NEW_QUESTIONS];

    function partitionByDifficulty(arr) {
        const easy = arr.filter(q => q.difficulty === 'easy');
        const hard = arr.filter(q => q.difficulty === 'hard');
        return { easy, hard };
    }

    // =========================
    // AUDIO - Brighter Piano + FX
    // =========================
    let isBgmPlaying = false;
    let bgmLoop = null;
    const fxReverb = new Tone.Reverb({ decay: 1.2, wet: 0.22 }).toDestination();

    const pianoSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.6, sustain: 0.5, release: 1.0 }
    }).connect(fxReverb);
    pianoSynth.volume.value = -18;

    const correctSynth = new Tone.PolySynth(Tone.Synth, {
        oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.12, sustain: 0, release: 0.2 }
    }).connect(fxReverb);
    correctSynth.volume.value = -8;

    const wrongSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.25 } }).toDestination();
    wrongSynth.volume.value = -12;

    function playApplause() {
        if (isMuted) return;
        const now = Tone.now();
        correctSynth.triggerAttackRelease(["E5","G5","C6"], "8n", now, 0.9);
        correctSynth.triggerAttackRelease("C6", "8n", now + 0.12, 0.8);
        try { launchConfetti(3000, 140); } catch(e) {}
    }

    function playSadHorn() {
        if (isMuted) return;
        const horn = new Tone.Synth({ oscillator:{ type:'sawtooth' }, envelope:{ attack:0.02, decay:0.5, sustain:0.1, release:0.6 }}).toDestination();
        horn.volume.value = -10;
        const now = Tone.now();
        horn.triggerAttackRelease("G4", "8n", now);
        horn.triggerAttackRelease("Eb4", "8n", now + 0.15);
        setTimeout(()=> horn.dispose(), 800);
    }

    function playTeoTeo() {
        if (isMuted) return;
        const s = new Tone.Synth({ oscillator:{ type:'triangle' }, envelope:{ attack:0.001, decay:0.08, sustain:0, release:0.05 }}).toDestination();
        s.volume.value = -8;
        const now = Tone.now();
        s.triggerAttackRelease("C6", "32n", now);
        s.triggerAttackRelease("B5", "32n", now + 0.07);
        s.triggerAttackRelease("G5", "32n", now + 0.14);
        setTimeout(()=> s.dispose(), 400);
    }

    function playFanfare() {
        if (isMuted) return;
        const fan = new Tone.PolySynth(Tone.Synth, { oscillator:{ type:'triangle' }, envelope:{ attack:0.01, decay:0.4, sustain:0.2, release:0.6 } }).toDestination();
        fan.volume.value = -6;
        const now = Tone.now();
        fan.triggerAttackRelease(["C5","E5","G5"], "8n", now);
        fan.triggerAttackRelease(["G5","B5","D6"], "8n", now + 0.18);
        setTimeout(()=> fan.dispose(), 900);
        try { launchConfetti(4200, 220); } catch(e){}
    }

    function startBGM() {
        if (isMuted) return;
        Tone.start();
        if (isBgmPlaying) return;
        isBgmPlaying = true;
        if (!bgmLoop) {
            let idx = 0;
            const progression = ["C4","E4","G4","A3","D4","F4"];
            bgmLoop = new Tone.Loop(time => {
                const root = progression[idx % progression.length];
                pianoSynth.triggerAttackRelease(root, "2n", time, 0.6);
                if (Math.random() > 0.5) {
                    pianoSynth.triggerAttackRelease(Tone.Frequency(root).transpose(7).toNote(), "8n", time + 0.05, 0.6);
                } else {
                    pianoSynth.triggerAttackRelease(Tone.Frequency(root).transpose(12).toNote(), "8n", time + 0.05, 0.45);
                }
                idx++;
            }, "2n").start(0);
        }
        Tone.Transport.bpm.value = 75;
        Tone.Transport.start();
    }

    function stopBGM() {
        if (!isBgmPlaying) return;
        if (bgmLoop) bgmLoop.stop();
        pianoSynth.releaseAll();
        Tone.Transport.stop();
        isBgmPlaying = false;
    }

    function playCorrectSound() {
        if (isMuted) return;
        const now = Tone.now();
        correctSynth.triggerAttackRelease("G6", "64n", now, 0.85);
        correctSynth.triggerAttackRelease("B6", "64n", now + 0.05, 0.85);
    }

    function playWrongSound() {
        if (isMuted) return;
        wrongSynth.triggerAttackRelease("8n");
    }

    // =========================
    // HELPERS
    // =========================
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function pickAndRemove(sourceArr, count) {
        const picked = [];
        shuffle(sourceArr);
        for (let i = 0; i < count && sourceArr.length > 0; i++) {
            picked.push(sourceArr.shift());
        }
        return picked;
    }

    // =========================
    // PREPARE ROUNDS (no duplicates)
    // =========================
    function prepareRounds() {
        const { easy, hard } = partitionByDifficulty([...ALL_QUESTIONS]);
        shuffle(easy); shuffle(hard);
        const easyPool = [...easy];
        const hardPool = [...hard];

        const r1_easy = pickAndRemove(easyPool, 8);
        const r1_hard = pickAndRemove(hardPool, 2);
        const round1 = shuffle([...r1_easy, ...r1_hard]);

        const r2_hard = pickAndRemove(hardPool, 8);
        const r2_easy = pickAndRemove(easyPool, 2);

        if (r2_hard.length < 8) {
            const need = 8 - r2_hard.length;
            r2_hard.push(...pickAndRemove(easyPool, need));
        }
        if (r2_easy.length < 2) {
            const need = 2 - r2_easy.length;
            r2_easy.push(...pickAndRemove(hardPool, need));
        }

        let round2 = shuffle([...r2_hard, ...r2_easy]);

        // Final safety: ensure unique ids between rounds
        const ids1 = new Set(round1.map(q => q.id));
        let filteredRound2 = round2.filter(q => !ids1.has(q.id));
        if (filteredRound2.length < 10) {
            const remaining = ALL_QUESTIONS.filter(q => !ids1.has(q.id) && !filteredRound2.find(x=>x.id===q.id));
            shuffle(remaining);
            while (filteredRound2.length < 10 && remaining.length) filteredRound2.push(remaining.shift());
        }

        roundQuestions[1] = round1.slice(0,10);
        roundQuestions[2] = filteredRound2.slice(0,10);
    }

    // =========================
    // TIMER
    // =========================
    let MAX_TIME = 40;
    function startTimerUI() {
        startTime = Date.now();
        isAnswered = false;
        clearInterval(timerInterval);
        const bar = document.getElementById('timer-bar');
        if (!bar) return;
        timerInterval = setInterval(() => {
            const elapsed = (Date.now() - startTime) / 1000;
            const timeLeft = Math.max(0, MAX_TIME - elapsed);
            const perc = (timeLeft / MAX_TIME) * 100;
            bar.style.width = perc + '%';
            if (perc > 50) bar.style.background = '#10b981';
            else if (perc > 20) bar.style.background = '#f59e0b';
            else bar.style.background = '#ef4444';

            if (elapsed >= MAX_TIME) {
                clearInterval(timerInterval);
                if (!isAnswered) handleTimeout();
            }
        }, 100);
    }

    function stopTimerUI() {
        clearInterval(timerInterval);
    }

    function handleTimeout() {
        isAnswered = true;
        stopTimerUI();
        const currentQ = roundQuestions[round][currentQuestionIndex];
        if (round === 2) {
            totalScore -= 200;
            if (totalScore < 0) totalScore = 0;
            playWrongSound();
            playTeoTeo();
            showFeedback(false, 0, currentQ.info, currentQ.correctIndex);
        } else {
            playWrongSound();
            showFeedback(false, 0, currentQ.info, currentQ.correctIndex);
        }
    }

    // =========================
    // RENDER / FLOW
    // =========================
    function renderApp() {
        appContainer.innerHTML = '';
        modalContainer.classList.add('hidden');

        switch (gameState) {
            case GAME_STATE.NAME_INPUT:
                stopBGM();
                renderNameInput();
                break;
            case GAME_STATE.INSTRUCTIONS:
                startBGM();
                renderInstructions();
                break;
            case GAME_STATE.QUIZ:
                renderQuiz();
                break;
            case GAME_STATE.ROUND_END:
                // handled elsewhere
                break;
            case GAME_STATE.RESULTS:
                renderResults();
                break;
            default:
                renderNameInput();
        }
    }

    function renderNameInput() {
        appContainer.innerHTML = `
            <div class="text-center p-4 md:p-8 font-normal">
                <h2 class="text-4xl font-header-footer text-red-600 mb-6 animate-pulse">B·∫ÆT ƒê·∫¶U TR√í CH∆†I</h2>
                <p class="text-gray-600 text-lg mb-4 font-normal">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi h√†nh tr√¨nh t√¨m hi·ªÉu v·ªÅ B√°c H·ªì k√≠nh y√™u!</p>
                <div class="max-w-md mx-auto">
                    <input id="player-name-input" type="text" placeholder="Nh·∫≠p H·ªç T√™n c·ªßa b·∫°n"
                        class="w-full p-4 border-2 border-gray-300 rounded-lg text-lg font-normal focus:outline-none focus:ring-4 focus:ring-blue-500 transition duration-300"
                        value="${playerName}">
                    <button id="start-button" class="mt-6 w-full py-4 rounded-full text-white font-bold text-xl font-header-footer transition duration-300 bg-blue-600 hover:bg-blue-700 shadow-xl" disabled>B·∫ÆT ƒê·∫¶U TR√í CH∆†I <i class="fas fa-play ml-2"></i></button>
                </div>
            </div>
        `;
        const nameInput = document.getElementById('player-name-input');
        const startButton = document.getElementById('start-button');
        nameInput.addEventListener('input', () => {
            playerName = nameInput.value.trim();
            startButton.disabled = playerName.length < 2;
        });
        nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !startButton.disabled) handleNameSubmit(); });
        startButton.addEventListener('click', handleNameSubmit);
    }

    function handleNameSubmit() {
        playerName = document.getElementById('player-name-input').value.trim();
        if (!playerName) return;
        prepareRounds();
        gameState = GAME_STATE.INSTRUCTIONS;
        renderApp();
    }

    // Instructions (styled)
    function renderInstructions() {
        appContainer.innerHTML = `
            <div class="p-4 md:p-8 font-normal text-center">
                <h2 class="text-3xl font-header-footer text-red-600 mb-6">LU·∫¨T CH∆†I</h2>
                <p class="text-lg text-gray-700 mb-4 font-normal">Xin ch√†o <span class="font-bold text-red-800">${escapeHtml(playerName)}</span>! R·∫•t vui v√¨ b·∫°n ƒë·∫øn tham gia h√†nh tr√¨nh t√¨m hi·ªÉu v·ªÅ B√°c H·ªì. Ch∆°i vui v√† h·ªçc hay nh√© üí´</p>

                <div class="space-y-6 text-left max-w-xl mx-auto text-gray-800">
                    <div class="rule-box rule-blue">
                        <i class="fas fa-info-circle rule-icon text-blue-700"></i>
                        <div>
                            <p class="rule-title">C·∫•u tr√∫c tr√≤ ch∆°i</p>
                            <p class="rule-text mt-1">Tr√≤ ch∆°i g·ªìm hai v√≤ng: V√≤ng 1 gi√∫p b·∫°n l√†m quen v·ªõi nh·ªØng ki·∫øn th·ª©c c∆° b·∫£n v√† m·ªôt v√†i c√¢u c·∫ßn t∆∞ duy; V√≤ng 2 s·∫Ω th·ª≠ th√°ch h∆°n v·ªõi nhi·ªÅu c√¢u ƒë√≤i h·ªèi suy nghƒ© s√¢u h∆°n.</p>
                        </div>
                    </div>

                    <div class="rule-box rule-indigo">
                        <i class="fas fa-layer-group rule-icon text-indigo-700"></i>
                        <div>
                            <p class="rule-title">V√≤ng 1 ‚Äî Kh·ªüi ƒë·ªông</p>
                            <ul class="list-disc ml-6 mt-2 rule-text">
                                <li>10 c√¢u tr·∫Øc nghi·ªám, m·ªói c√¢u 4 ph∆∞∆°ng √°n.</li>
                                <li>M·ªói c√¢u c√≥ <strong>40 gi√¢y</strong> ƒë·ªÉ tr·∫£ l·ªùi.</li>
                                <li>Tr·∫£ l·ªùi ƒë√∫ng: ƒëi·ªÉm c√†ng cao n·∫øu b·∫°n tr·∫£ l·ªùi c√†ng nhanh (t·ªëi ƒëa <strong>1000 ƒëi·ªÉm/c√¢u</strong>).</li>
                                <li>Tr·∫£ l·ªùi sai ho·∫∑c h·∫øt gi·ªù: <strong>0 ƒëi·ªÉm</strong> cho c√¢u ƒë√≥.</li>
                                <li>N·∫øu t·ªïng ƒëi·ªÉm sau V√≤ng 1 ƒë·∫°t <strong>&ge; 6000 ƒëi·ªÉm</strong>, b·∫°n s·∫Ω ƒë∆∞·ª£c m·ªùi b∆∞·ªõc v√†o V√≤ng 2.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="rule-box rule-yellow">
                        <i class="fas fa-bolt rule-icon text-yellow-700"></i>
                        <div>
                            <p class="rule-title">V√≤ng 2 ‚Äî Th·ª≠ th√°ch</p>
                            <ul class="list-disc ml-6 mt-2 rule-text">
                                <li>10 c√¢u tr·∫Øc nghi·ªám, m·ªói c√¢u 4 ph∆∞∆°ng √°n.</li>
                                <li>M·ªói c√¢u c√≥ <strong>30 gi√¢y</strong> ƒë·ªÉ tr·∫£ l·ªùi.</li>
                                <li>Tr·∫£ l·ªùi ƒë√∫ng: ƒëi·ªÉm theo th·ªùi gian (t·ªëi ƒëa <strong>1000 ƒëi·ªÉm/c√¢u</strong>).</li>
                                <li>Tr·∫£ l·ªùi sai ho·∫∑c h·∫øt gi·ªù: <strong>-200 ƒëi·ªÉm</strong> cho m·ªói l·∫ßn.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="rule-box rule-green">
                        <i class="fas fa-smile-beam rule-icon text-green-700"></i>
                        <div>
                            <p class="rule-title">M·ªôt v√†i l∆∞u √Ω nh·ªè</p>
                            <ul class="list-disc ml-6 mt-2 rule-text">
                                <li>Sau m·ªói c√¢u, b·∫°n s·∫Ω th·∫•y th√¥ng b√°o cho bi·∫øt b·∫°n tr·∫£ l·ªùi ƒë√∫ng hay sai, s·ªë ƒëi·ªÉm nh·∫≠n ƒë∆∞·ª£c, ƒë√°p √°n ƒë√∫ng v√† m·ªôt ƒëo·∫°n gi·∫£i th√≠ch ng·∫Øn.</li>
                                <li>B·∫°n c√≥ th·ªÉ t·∫Øt/b·∫≠t nh·∫°c n·ªÅn b·∫±ng n√∫t <em>√¢m thanh</em> ·ªü g√≥c ph·∫£i n·∫øu c·∫ßn.</li>
                            </ul>
                        </div>
                    </div>

                </div>

                <button id="confirm-rules" class="mt-8 px-8 py-4 rounded-full text-white font-bold text-xl font-header-footer transition duration-300 btn-confirm shadow-xl">
                    M√åNH ƒê√É HI·ªÇU LU·∫¨T CH∆†I <i class="fas fa-check ml-2"></i>
                </button>
            </div>
        `;
        document.getElementById('confirm-rules').addEventListener('click', startGame);
    }

    function startGame() {
        Tone.start().then(() => startBGM());
        totalScore = 0;
        round = 1;
        currentQuestionIndex = 0;
        gameState = GAME_STATE.QUIZ;
        renderApp();
    }

    // Render Quiz, handle answers, feedback, leaderboard etc.
    function renderQuiz() {
        const qs = roundQuestions[round];
        if (!qs || qs.length === 0) { showRoundEnd(); return; }
        if (currentQuestionIndex >= qs.length) { showRoundEnd(); return; }

        MAX_TIME = round === 1 ? 40 : 30;
        const currentQ = qs[currentQuestionIndex];
        const qNumber = currentQuestionIndex + 1;
        const totalQ = qs.length;
        const answerColors = ['color-1','color-2','color-3','color-4'];

        appContainer.innerHTML = `
            <div class="p-2 md:p-4 font-quiz">
                <div id="timer-bar-container"><div id="timer-bar" style="width:100%; transition-duration:${MAX_TIME}s;"></div></div>
                <div class="text-center mb-4">
                    <p class="text-xl font-bold text-blue-600">V√≤ng ${round} ‚Äî C√¢u ${qNumber}/${totalQ}</p>
                    <p class="text-sm text-gray-600 mt-1">T·ªïng ƒëi·ªÉm hi·ªán t·∫°i: <span class="font-bold text-blue-700">${totalScore.toLocaleString()} ƒëi·ªÉm</span></p>
                </div>

                <div class="bg-blue-100 p-6 rounded-lg mb-6 shadow-lg text-center">
                    <h3 class="text-xl md:text-2xl font-bold text-gray-800 font-quiz">${currentQ.q}</h3>
                </div>

                <div id="answers-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${currentQ.a.map((ans, idx) => `
                        <button class="answer-button flex items-center justify-center min-h-[88px] p-4 md:p-6 rounded-xl text-white text-lg font-bold shadow-lg ${answerColors[idx]}"
                            onclick="handleAnswerClick(${idx})" data-index="${idx}" aria-label="Tr·∫£ l·ªùi ${idx+1}">
                            ${ans}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        startTimerUI();
    }

    function handleAnswerClick(selectedIndex) {
        if (isAnswered) return;
        isAnswered = true;
        stopTimerUI();
        const currentQ = roundQuestions[round][currentQuestionIndex];
        const timeTaken = (Date.now() - startTime) / 1000;
        const isCorrect = selectedIndex === currentQ.correctIndex;

        let pointsEarned = 0;
        if (isCorrect) {
            pointsEarned = calculateScore(timeTaken, MAX_TIME);
            totalScore += pointsEarned;
            playCorrectSound();
        } else {
            playWrongSound();
            if (round === 2) {
                totalScore -= 200;
                if (totalScore < 0) totalScore = 0;
                playTeoTeo();
            }
        }

        const buttons = document.querySelectorAll('.answer-button');
        buttons.forEach((btn, idx) => {
            btn.disabled = true;
            btn.classList.remove('shadow-lg');
            btn.style.opacity = '0.6';
            if (idx === selectedIndex) {
                btn.style.opacity = '1';
                btn.classList.add(isCorrect ? 'ring-4' : 'ring-4');
                btn.classList.add(isCorrect ? 'ring-green-500' : 'ring-red-500');
            }
            if (idx === currentQ.correctIndex) {
                btn.style.opacity = '1';
                btn.classList.add('ring-4','ring-green-500','ring-offset-2');
            }
        });

        showFeedback(isCorrect, pointsEarned, currentQ.info, currentQ.correctIndex);
    }

    function calculateScore(timeTaken, maxTime) {
        if (timeTaken < 0.5) return MAX_POINTS_PER_QUESTION;
        const ratio = timeTaken / maxTime;
        const halvedRatio = ratio / 2;
        const multiplier = Math.max(0, 1 - halvedRatio);
        const raw = MAX_POINTS_PER_QUESTION * multiplier;
        return Math.round(raw);
    }

    function showFeedback(isCorrect, pointsEarned, explanation, correctIndex) {
        modalTitle.textContent = isCorrect ? "B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng r·ªìi n√®!" : "Ti·∫øc qu√°, b·∫°n ƒë√£ tr·∫£ l·ªùi sai r·ªìi!";
        modalTitle.classList.remove('text-red-600','text-green-600');
        modalTitle.classList.add(isCorrect ? 'text-green-600':'text-red-600');

        modalMessage.innerHTML = `T·ªïng ƒëi·ªÉm hi·ªán t·∫°i: <span class="font-bold text-blue-600">${totalScore.toLocaleString()} ƒëi·ªÉm</span>`;
        modalScore.textContent = (isCorrect ? '+' : '') + pointsEarned.toLocaleString() + ' ƒëi·ªÉm';
        modalScore.classList.remove('hidden');

        const correctLabel = String.fromCharCode(65 + correctIndex);
        modalCorrect.innerHTML = `<strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctLabel}. <span class="ml-2 text-gray-700">${roundQuestions[round][currentQuestionIndex].a[correctIndex]}</span>`;
        modalCorrect.classList.remove('hidden');

        modalExplanation.innerHTML = `<strong>Th√¥ng tin th√™m:</strong><br>${explanation || ''}`;
        modalExplanation.classList.remove('hidden');

        modalButtons.innerHTML = '';
        const nextBtn = document.createElement('button');
        nextBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-blue-600 hover:bg-blue-700';
        nextBtn.textContent = 'C√¢u ti·∫øp theo';
        nextBtn.onclick = () => {
            currentQuestionIndex++;
            modalContainer.classList.add('hidden');
            modalScore.classList.add('hidden');
            modalExplanation.classList.add('hidden');
            modalCorrect.classList.add('hidden');
            renderApp();
        };
        modalButtons.appendChild(nextBtn);

        modalContainer.classList.remove('hidden');
    }

    function showRoundEnd() {
        const name = playerName;
        modalTitle.textContent = `K·∫øt th√∫c V√≤ng ${round}`;
        modalTitle.classList.remove('text-red-600','text-green-600');
        modalTitle.classList.add('text-gray-800');
        modalMessage.innerHTML = `S·ªë ƒëi·ªÉm c·ªßa b·∫°n <strong>${name}</strong> l√†: <span class="font-bold text-blue-600">${totalScore.toLocaleString()} ƒëi·ªÉm</span>`;

        modalScore.classList.add('hidden');
        modalCorrect.classList.add('hidden');
        modalExplanation.classList.add('hidden');
        modalButtons.innerHTML = '';

        if (round === 1) {
            if (totalScore >= 6000) {
                const congr = document.createElement('p');
                congr.className = 'text-green-700 font-bold my-3';
                congr.textContent = `Ch√∫c m·ª´ng b·∫°n ${name} ƒë√£ ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ b∆∞·ªõc v√†o v√≤ng 2.`;
                modalExplanation.innerHTML = '';
                modalExplanation.appendChild(congr);
                modalExplanation.classList.remove('hidden');

                const readyBtn = document.createElement('button');
                readyBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-indigo-600 hover:bg-indigo-700';
                readyBtn.textContent = 'M√¨nh ƒë√£ s·∫µn s√†ng ƒë·ªÉ b∆∞·ªõc v√†o v√≤ng 2';
                readyBtn.onclick = () => {
                    modalContainer.classList.add('hidden');
                    playApplause();
                    round = 2;
                    currentQuestionIndex = 0;
                    gameState = GAME_STATE.QUIZ;
                    renderApp();
                };
                modalButtons.appendChild(readyBtn);
            } else {
                const msg = document.createElement('p');
                msg.className = 'text-red-700 font-semibold my-2';
                msg.textContent = `Ti·∫øc qu√°, b·∫°n ${name} kh√¥ng ƒë·ªß ƒëi·ªÉm ƒë·ªÉ b∆∞·ªõc v√†o v√≤ng 2.`;
                modalExplanation.innerHTML = '';
                modalExplanation.appendChild(msg);
                modalExplanation.classList.remove('hidden');

                const homeBtn = document.createElement('button');
                homeBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-blue-600 hover:bg-blue-700';
                homeBtn.textContent = 'Quay v·ªÅ trang ch·ªß';
                homeBtn.onclick = () => { modalContainer.classList.add('hidden'); resetToHome(); };

                const replayBtn = document.createElement('button');
                replayBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-red-600 hover:bg-red-700';
                replayBtn.textContent = 'Ch∆°i l·∫°i';
                replayBtn.onclick = () => { modalContainer.classList.add('hidden'); replayGame(); };

                modalButtons.appendChild(homeBtn);
                modalButtons.appendChild(replayBtn);

                playSadHorn();
                setTimeout(playTeoTeo, 300);
            }
        } else {
            modalTitle.textContent = `üéâ CH√öC M·ª™NG B·∫†N ${playerName.toUpperCase()} ƒê√É HO√ÄN TH√ÄNH TR√í CH∆†I! üéâ`;
            modalTitle.classList.remove('text-red-600');
            modalTitle.classList.add('text-green-600');

            modalScore.textContent = `${totalScore.toLocaleString()} ƒëi·ªÉm`;
            modalScore.classList.remove('hidden');

            const finishBtn = document.createElement('button');
            finishBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-blue-600 hover:bg-blue-700';
            finishBtn.textContent = 'L∆∞u ƒëi·ªÉm & Xem b·∫£ng x·∫øp h·∫°ng';
            finishBtn.onclick = () => {
                modalContainer.classList.add('hidden');
                saveScoreToLeaderboard(playerName, totalScore).then(() => {
                    openLeaderboard();
                }).catch((e) => {
                    console.error(e);
                    openLeaderboard();
                });
            };

            const homeBtn = document.createElement('button');
            homeBtn.className = 'px-6 py-3 rounded-full text-white font-bold bg-gray-500 hover:bg-gray-600';
            homeBtn.textContent = 'V·ªÅ trang ch·ªß';
            homeBtn.onclick = () => { modalContainer.classList.add('hidden'); resetToHome(); };

            modalButtons.appendChild(finishBtn);
            modalButtons.appendChild(homeBtn);
            playFanfare();
        }

        modalContainer.classList.remove('hidden');
    }

    function renderResults() { showRoundEnd(); }
    function resetToHome() {
        playerName = '';
        totalScore = 0;
        currentQuestionIndex = 0;
        round = 1;
        gameState = GAME_STATE.NAME_INPUT;
        stopBGM();
        renderApp();
    }
    function replayGame() {
        totalScore = 0;
        currentQuestionIndex = 0;
        round = 1;
        prepareRounds();
        gameState = GAME_STATE.QUIZ;
        renderApp();
    }

    // =========================
    // LEADERBOARD (Firebase or localStorage)
    // =========================
    async function saveScoreToLeaderboard(name, score) {
        const entry = { name, score: Number(score), timestamp: Date.now() };
        if (useFirebase) {
            const ref = firebase.database().ref('leaderboard');
            await ref.push(entry);
            return;
        } else {
            const key = 'local_leaderboard_v1';
            const list = JSON.parse(localStorage.getItem(key) || "[]");
            list.push(entry);
            list.sort((a,b) => b.score - a.score);
            localStorage.setItem(key, JSON.stringify(list.slice(0, 100)));
            return;
        }
    }

    async function getTopLeaderboard(limit = 10) {
        if (useFirebase) {
            const ref = firebase.database().ref('leaderboard').orderByChild('score').limitToLast(limit);
            const snapshot = await ref.once('value');
            const data = snapshot.val() || {};
            const arr = Object.keys(data).map(k => ({ key: k, ...data[k] }));
            arr.sort((a,b) => b.score - a.score);
            return arr;
        } else {
            const key = 'local_leaderboard_v1';
            const list = JSON.parse(localStorage.getItem(key) || "[]");
            list.sort((a,b) => b.score - a.score);
            return list.slice(0, limit);
        }
    }

    function renderLeaderboardList(items) {
        leaderboardList.innerHTML = '';
        if (!items || items.length === 0) {
            leaderboardList.innerHTML = `<div class="text-center p-4">Ch∆∞a c√≥ d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng.</div>`;
            return;
        }
        items.forEach((it, idx) => {
            const rank = idx + 1;
            const row = document.createElement('div');
            row.className = 'leaderboard-row bg-gradient-to-r from-white to-gray-50 p-3 rounded-xl';
            const badge = document.createElement('div');
            badge.className = 'leaderboard-badge ' + (rank === 1 ? 'leader-rank-1' : rank === 2 ? 'leader-rank-2' : rank === 3 ? 'leader-rank-3' : 'leader-rank');
            badge.innerHTML = `<span>${rank}</span>`;
            const nameDiv = document.createElement('div');
            nameDiv.innerHTML = `<div class="font-bold">${escapeHtml(it.name)}</div><div class="text-sm text-gray-500">ID: ${it.key ? it.key.slice(0,6) : '-'}</div>`;
            const scoreDiv = document.createElement('div');
            scoreDiv.className = 'ml-auto text-right';
            scoreDiv.innerHTML = `<div class="text-xl font-bold text-blue-600">${Number(it.score).toLocaleString()}</div><div class="text-sm text-gray-500">${new Date(it.timestamp || Date.now()).toLocaleDateString()}</div>`;
            row.appendChild(badge);
            row.appendChild(nameDiv);
            row.appendChild(scoreDiv);
            leaderboardList.appendChild(row);
        });
    }

    function openLeaderboard() {
        getTopLeaderboard(10).then(items => {
            renderLeaderboardList(items);
            leaderboardModal.classList.remove('hidden');
        }).catch(err => {
            console.error(err);
            leaderboardList.innerHTML = `<div class="p-4">L·ªói khi t·∫£i b·∫£ng x·∫øp h·∫°ng.</div>`;
            leaderboardModal.classList.remove('hidden');
        });
    }

    openLeaderboardBtn.addEventListener('click', openLeaderboard);
    closeLeaderboardBtn.addEventListener('click', () => { leaderboardModal.classList.add('hidden'); });
    refreshLeaderboardBtn.addEventListener('click', () => { getTopLeaderboard(10).then(items => renderLeaderboardList(items)); });

    if (useFirebase) {
        try {
            const dbRef = firebase.database().ref('leaderboard').limitToLast(10);
            dbRef.on('value', (snap) => {
                const data = snap.val() || {};
                const arr = Object.keys(data).map(k => ({ key: k, ...data[k] }));
                arr.sort((a,b) => b.score - a.score);
                if (!leaderboardModal.classList.contains('hidden')) renderLeaderboardList(arr);
            });
        } catch (e) {
            console.warn('Realtime leaderboard listener failed', e);
        }
    }

    // =========================
    // CONFETTI
    // =========================
    function launchConfetti(duration = 3000, particleCount = 150) {
        const canvas = document.createElement('canvas');
        canvas.className = 'confetti-canvas';
        canvas.style.position = 'fixed';
        canvas.style.top = 0; canvas.style.left = 0;
        canvas.style.width = '100%'; canvas.style.height = '100%';
        canvas.style.pointerEvents = 'none';
        canvas.style.zIndex = 1000;
        document.body.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resize(); window.addEventListener('resize', resize);
        const colors = ['#FFC700','#FF6B6B','#6BCB77','#4D96FF','#C86DD7','#FF8C42'];
        const particles = [];
        for (let i=0;i<particleCount;i++){
            particles.push({
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height - canvas.height,
                size: Math.random()*8+6,
                tilt: Math.random()*20 - 10,
                color: colors[Math.floor(Math.random()*colors.length)],
                vx: (Math.random()-0.5)*6,
                vy: Math.random()*6 + 2,
                rot: Math.random()*Math.PI
            });
        }
        let start = performance.now();
        function draw(now){
            const elapsed = now - start;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            for (let p of particles) {
                p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.rot += 0.08;
                ctx.save();
                ctx.translate(p.x,p.y);
                ctx.rotate(p.rot);
                ctx.fillStyle = p.color;
                ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6);
                ctx.restore();
            }
            if (elapsed < duration) requestAnimationFrame(draw);
            else cleanup();
        }
        function cleanup(){ window.removeEventListener('resize', resize); if (canvas && canvas.parentNode) canvas.parentNode.removeChild(canvas); }
        requestAnimationFrame(draw);
        setTimeout(cleanup, duration+1200);
    }

    // =========================
    // HELPERS & INIT
    // =========================
    function escapeHtml(text) {
        return String(text).replace(/[&<>"'\/]/g, function (s) {
            const entityMap = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': '&quot;', "'": '&#39;', "/": '&#x2F;' };
            return entityMap[s];
        });
    }

    muteButton.addEventListener('click', () => {
        isMuted = !isMuted;
        muteIcon.className = isMuted ? 'fas fa-volume-mute text-gray-400' : 'fas fa-volume-up text-blue-600';
        if (isMuted) stopBGM();
        else startBGM();
    });

    window.onload = function() {
        Tone.loaded().then(() => { renderApp(); }).catch((e) => { console.warn('Tone load error', e); renderApp(); });
    };

    </script>
</body>
</html>

